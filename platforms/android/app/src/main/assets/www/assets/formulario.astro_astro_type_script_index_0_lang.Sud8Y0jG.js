document.addEventListener("DOMContentLoaded",()=>{const h=document.getElementById("btnAbrirSelector"),r=document.getElementById("selectorModal"),E=document.getElementById("btnCerrarModal"),y=document.getElementById("opcionCamara"),T=document.getElementById("opcionGaleria"),n=document.getElementById("archivo"),C=document.getElementById("archivoDesdeModal"),w=document.getElementById("previewContainer"),s=document.getElementById("previewImage"),f=document.getElementById("archivoNombre"),L=document.getElementById("btnEliminarPreview"),p=document.getElementById("imagePreview"),v=document.getElementById("pdfPreview"),d=document.getElementById("archivoTama√±o"),l=document.getElementById("archivoTipo"),A=typeof window.cordova<"u";h&&r&&h.addEventListener("click",()=>{r.classList.remove("hidden")});function m(){r&&r.classList.add("hidden")}E&&E.addEventListener("click",m),r&&r.addEventListener("click",e=>{e.target===r&&m()});function P(e){if(e===0)return"0 Bytes";const t=1024,i=["Bytes","KB","MB","GB"],o=Math.floor(Math.log(e)/Math.log(t));return Math.round(e/Math.pow(t,o)*100)/100+" "+i[o]}function b(e){return e.type.startsWith("image/")?"Imagen":e.type==="application/pdf"?"PDF":"Archivo"}function g(e,t,i,o){if(!(!w||!f))if(e||t){const a=e?e.type.startsWith("image/"):o?.startsWith("image/")||!o||t?.startsWith("data:image"),c=e?e.type==="application/pdf":o==="application/pdf"||i?.toLowerCase().endsWith(".pdf");if(p&&v&&(a?(p.classList.remove("hidden"),v.classList.add("hidden")):c?(p.classList.add("hidden"),v.classList.remove("hidden")):(p.classList.add("hidden"),v.classList.add("hidden"))),t)a&&s&&(s.src=t),f.textContent=i||"Archivo seleccionado",d&&(d.textContent=""),l&&(l.textContent=a?"Imagen":c?"PDF":"Archivo");else if(e){if(a){const u=new FileReader;u.onload=B=>{B.target?.result&&s&&(s.src=B.target.result)},u.readAsDataURL(e)}f.textContent=e.name,d&&(d.textContent=P(e.size)),l&&(l.textContent=b(e))}w.classList.remove("hidden")}else w.classList.add("hidden"),s&&(s.src=""),f&&(f.textContent=""),d&&(d.textContent=""),l&&(l.textContent="")}function I(e,t){const i=e.split(","),o=i[0].match(/:(.*?);/)?.[1]||"image/jpeg",a=atob(i[1]);let c=a.length;const u=new Uint8Array(c);for(;c--;)u[c]=a.charCodeAt(c);return new File([u],t,{type:o})}function D(){if(m(),!A){n&&(n.setAttribute("capture","environment"),n.click(),n.removeAttribute("capture"));return}window.navigator?.camera?window.navigator.camera.getPicture(e=>{const t="data:image/jpeg;base64,"+e,i="foto-"+Date.now()+".jpg";g(null,t,i,"image/jpeg");const o=I(t,i),a=new DataTransfer;a.items.add(o),n&&(n.files=a.files)},e=>{console.error("Error al tomar foto:",e),alert("Error al tomar la foto. Por favor, intenta de nuevo.")},{quality:75,destinationType:window.Camera.DestinationType.DATA_URL,sourceType:window.Camera.PictureSourceType.CAMERA,allowEdit:!0,encodingType:window.Camera.EncodingType.JPEG,targetWidth:1024,targetHeight:1024,saveToPhotoAlbum:!1}):n&&(n.setAttribute("capture","environment"),n.click())}function M(){if(m(),!A){n&&(n.removeAttribute("capture"),n.click());return}window.navigator?.camera?window.navigator.camera.getPicture(e=>{const t="data:image/jpeg;base64,"+e,i="imagen-"+Date.now()+".jpg";g(null,t,i,"image/jpeg");const o=I(t,i),a=new DataTransfer;a.items.add(o),n&&(n.files=a.files)},e=>{console.error("Error al seleccionar imagen:",e),alert("Error al seleccionar la imagen. Por favor, intenta de nuevo.")},{quality:75,destinationType:window.Camera.DestinationType.DATA_URL,sourceType:window.Camera.PictureSourceType.PHOTOLIBRARY,allowEdit:!0,encodingType:window.Camera.EncodingType.JPEG,targetWidth:1024,targetHeight:1024,mediaType:window.Camera.MediaType.PICTURE}):n&&(n.removeAttribute("capture"),n.click())}y&&y.addEventListener("click",D),T&&T.addEventListener("click",M),n&&n.addEventListener("change",e=>{const t=e.target;t.files&&t.files.length>0&&(g(t.files[0]),m())}),C&&C.addEventListener("change",e=>{const t=e.target;if(t.files&&t.files.length>0){const i=new DataTransfer;i.items.add(t.files[0]),n&&(n.files=i.files),g(t.files[0]),m()}}),L&&L.addEventListener("click",()=>{g(null),n&&(n.value="")})});
